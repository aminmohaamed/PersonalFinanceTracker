@model PersonalFinanceTracker.ViewModels.TransactionViewModel
@{
    ViewBag.Title = "Edit Transaction";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-edit"></i> Edit Transaction
            </div>
            <div class="card-body">
                @using (Html.BeginForm("Edit", "Transaction", FormMethod.Post, new { @class = "transaction-form" }))
                {
                    @Html.AntiForgeryToken()
                    @Html.HiddenFor(m => m.TransactionId)
                    
                    @Html.ValidationSummary(false, "", new { @class = "alert alert-danger" })

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="Type" class="form-label">Transaction Type <span class="text-danger">*</span></label>
                            @Html.DropDownListFor(m => m.Type, 
                                new SelectList(Enum.GetValues(typeof(PersonalFinanceTracker.Models.TransactionType)).Cast<PersonalFinanceTracker.Models.TransactionType>().Select(e => new { Value = (int)e, Text = e.ToString() }), "Value", "Text"),
                                "Select Type",
                                new { @class = "form-select", required = "required", id = "transactionType" })
                            @Html.ValidationMessageFor(m => m.Type, "", new { @class = "text-danger small" })
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="CategoryId" class="form-label">Category <span class="text-danger">*</span></label>
                            @Html.DropDownListFor(m => m.CategoryId,
                                new SelectList(Model.AvailableCategories, "CategoryId", "Name"),
                                "Select Category",
                                new { @class = "form-select", required = "required", id = "categorySelect" })
                            @Html.ValidationMessageFor(m => m.CategoryId, "", new { @class = "text-danger small" })
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="Description" class="form-label">Description <span class="text-danger">*</span></label>
                        @Html.TextBoxFor(m => m.Description, new { @class = "form-control", placeholder = "Enter transaction description", required = "required" })
                        @Html.ValidationMessageFor(m => m.Description, "", new { @class = "text-danger small" })
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="Amount" class="form-label">Amount <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                @Html.TextBoxFor(m => m.Amount, new { @class = "form-control", type = "number", step = "0.01", min = "0.01", placeholder = "0.00", required = "required" })
                            </div>
                            @Html.ValidationMessageFor(m => m.Amount, "", new { @class = "text-danger small" })
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="Date" class="form-label">Date <span class="text-danger">*</span></label>
                            @Html.TextBoxFor(m => m.Date, "{0:yyyy-MM-dd}", new { @class = "form-control", type = "date", required = "required" })
                            @Html.ValidationMessageFor(m => m.Date, "", new { @class = "text-danger small" })
                        </div>
                    </div>

                    <div class="d-flex gap-2 justify-content-end mt-4">
                        <a href="@Url.Action("Index", "Transaction")" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Update Transaction
                        </button>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
        $(document).ready(function() {
            var allCategories = @Html.Raw(Json.Encode(Model.AvailableCategories.Select(c => new { 
                CategoryId = c.CategoryId, 
                Name = c.Name, 
                Type = (int)c.Type 
            })));

            var currentCategoryId = @Model.CategoryId;

            // Filter categories based on transaction type
            $('#transactionType').change(function() {
                var selectedType = parseInt($(this).val());
                var categorySelect = $('#categorySelect');
                
                categorySelect.empty();
                categorySelect.append('<option value="">Select Category</option>');

                if (selectedType) {
                    var filteredCategories = allCategories.filter(function(cat) {
                        return cat.Type == selectedType || cat.Type == 3; // 3 is Both
                    });

                    filteredCategories.forEach(function(cat) {
                        var option = $('<option></option>').val(cat.CategoryId).text(cat.Name);
                        if (cat.CategoryId == currentCategoryId) {
                            option.attr('selected', 'selected');
                        }
                        categorySelect.append(option);
                    });
                }
            });

            // Trigger on page load
            $('#transactionType').trigger('change');
        });
    </script>
}
